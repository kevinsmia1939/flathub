app-id: org.alicevision.Meshroom
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '5.15'
base: io.qt.qtwebengine.BaseApp
base-version: 5.15
rename-icon: paraview
command: paraview
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --share=network
  - --filesystem=home
cleanup:
  #- /include
  #- /lib/cmake
  #- /lib/pkgconfig
  #- /share/doc
  #- /share/man
  #- /etc
  #- *.la
  #- *.a

# Disable ARM support ParaView does not support it anyway.
modules:
  - shared-modules/glew/glew.json
  - shared-modules/glu/glu-9.json

  - name: freeglut
    buildsystem: cmake
    builddir: true
    #config-opts:
      #- -DBUILD_TESTING:BOOL=OFF
    sources:
      - type: archive
        url: http://prdownloads.sourceforge.net/freeglut/freeglut-3.2.1.tar.gz
        sha256: d4000e02102acaf259998c870e25214739d1f16f67f99cb35e4f46841399da68
        # Patch from openSUSE.
      - type: patch
        path: gcc10.patch
        strip-components: 3

  - name: Boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --prefix=/app
      - ./b2 -s --prefix=/app cflags=-fPIC -j$(nproc) link=shared install threading=multi
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.76.0/source/boost_1_76_0.tar.bz2
        sha256: f0397ba6e982c4450f27bf32a2a83292aba035b827a5623a14636ea583318c41

  - name: TBB
    buildsystem: simple
    build-commands:
      - make -j $FLATPAK_BUILDER_N_JOBS
      - install -d /app/lib
      - install -m755 build/linux_*/*.so* /app/lib
      - install -d /app/include
      - cp -a include/tbb /app/include
    sources:
      - type: archive
        url: https://github.com/oneapi-src/oneTBB/archive/refs/tags/2020_U3.tar.gz
        sha256: 2103cc6238c935664f87680618f6684d57501d4a2fa8ea8f6c97ad6ff7dc722a

  - name: openblas
    no-autogen: true
    make-args:
      - DYNAMIC_ARCH=1
      - DYNAMIC_OLDER=1
      - FC=gfortran
      - NO_CBLAS=1
      - NO_LAPACKE=1
      - TARGET=GENERIC
      - USE_OPENMP=1
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.15.tar.gz
        sha256: 30a99dec977594b387a17f49904523e6bc8dd88bd247266e83485803759e4bbe

  - name: Eigen3
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.3.9/eigen-3.3.9.tar.bz2
        sha256: 0fa5cafe78f66d2b501b43016858070d52ba47bd9b1016b0165a7b8e04675677
    cleanup:
      - "*"

  - name: MPFR
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/mpfr/mpfr-4.1.0.tar.xz
        sha256: 0c98a3f1732ff6ca4ea690552079da9c597872d30e96ec28414ee23c95558a7f

  - name: suitesparse
    make-args:
      - BLAS=-lopenblas
      - LAPACK=
      - library
    make-install-args:
      - BLAS=-lopenblas
      - LAPACK=
      - INSTALL_INCLUDE=/app/include/suitesparse
      - INSTALL_LIB=/app/lib
      - library
    no-autogen: true
    sources:
      - type: archive
        url: https://github.com/DrTimothyAldenDavis/SuiteSparse/archive/v5.10.1.tar.gz
        sha256: acb4d1045f48a237e70294b950153e48dce5b5f9ca8190e86c2b8c54ce00a7ee

  - name: Ceres-Solver
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DBUILD_TESTING:BOOL=OFF
      - -DBUILD_EXAMPLES:BOOL=OFF
      - -DBUILD_BENCHMARKS:BOOL=OFF
      - -DGFLAGS:BOOL=OFF
      - -DMINIGLOG:BOOL=ON
    sources:
      - type: archive
        url: https://github.com/ceres-solver/ceres-solver/archive/refs/tags/2.0.0.tar.gz
        sha256: 2ab0348e0f65fdf43bebcd325a1c73f7e8999691ee75e2a2981281931c42e9fa

  - name: Imath
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DBUILD_TESTING:BOOL=OFF
    sources:
      - type: git
        url: git://github.com/AcademySoftwareFoundation/Imath.git
        tag: v3.0.5

  - name: OpenEXR
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DOPENEXR_INSTALL_EXAMPLES:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/AcademySoftwareFoundation/openexr/archive/refs/tags/v3.0.5.tar.gz
        sha256: 7aa6645da70e9a0cce8215d25030cfd4f4b17b4abf1ceec314f7eae15674e8e4

  - name: libraw
    buildsystem: simple
    build-commands:
      - autoreconf -vfi
      - ./configure --disable-example --enable-lcms --prefix=/app
      - make
      - make install
    modules:
      shared-modules/openjpeg/openjpeg.json
    sources:
      - type: archive
        url: https://www.libraw.org/data/LibRaw-0.20.2.tar.gz
        sha256: dc1b486c2003435733043e4e05273477326e51c3ea554c6864a4eafaff1004a6
      #- type: archive
        #url: https://www.libraw.org/data/LibRaw-demosaic-pack-GPL2-0.18.8.tar.gz
        #sha256: 0b24bcf7bbb5d13fde58bb071f94dc9354be09bc44b2bba0698493065e99f8da
        #dest: ./LibRaw-demosaic-pack-GPL2
      #- type: archive
        #url: https://www.libraw.org/data/LibRaw-demosaic-pack-GPL3-0.18.8.tar.gz
        #sha256: ffd6916cd66c8101e4e6b589799f256c897748d2fd2486aa34c3705146dbc701
        #dest: ./LibRaw-demosaic-pack-GPL3

  - name: OpenColorIO
    buildsystem: cmake # ninja build broken (fixed in 2.0)
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DOCIO_BUILD_STATIC=OFF
      - -DCMAKE_CXX_FLAGS='-Wno-error=deprecated-declarations -Wno-error=unused-function -Wno-error=cast-function-type'
    build-options:
      arch:
        aarch64:
          config-opts:
            - -DOCIO_USE_SSE=NO
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://github.com/imageworks/OpenColorIO/archive/v1.1.1.tar.gz
        sha256: c9b5b9def907e1dafb29e37336b702fff22cc6306d445a13b1621b8a754c14c8

  #- name: DCMTK
    #buildsystem: cmake-ninja
    #builddir: true
    #sources:
      #- type: archive
        #url: https://dicom.offis.de/download/dcmtk/dcmtk366/dcmtk-3.6.6.tar.gz
        #sha256: 6859c62b290ee55677093cccfd6029c04186d91cf99c7642ae43627387f3458e

  #- name: Libheif
    #buildsystem: cmake-ninja
    #builddir: true
    #sources:
      #- type: archive
        #url: https://github.com/strukturag/libheif/archive/refs/tags/v1.12.0.tar.gz
        #sha256: 086145b0d990182a033b0011caadb1b642da84f39ab83aa66d005610650b3c65

  #- name: OpenVDB
    #buildsystem: cmake-ninja
    #builddir: true
    #sources:
      #- type: archive
        #url: https://github.com/AcademySoftwareFoundation/openvdb/archive/refs/tags/v8.1.0.tar.gz
        #sha256: 3e09d47331429be7409a3a3c27fdd3c297f96d31d2153febe194e664a99d6183

  #- name: Ptex
    #buildsystem: cmake-ninja
    #builddir: true
    #sources:
      #- type: archive
        #url: https://github.com/wdas/ptex/archive/refs/tags/v2.4.0.tar.gz
        #sha256: 690d66b72f34a92488d63134ad1f5736078677356b0004070b0169b9e3240f8e

  - name: fmt
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DFMT_TEST:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/fmtlib/fmt/archive/refs/tags/8.0.1.tar.gz
        sha256: b06ca3130158c625848f3fb7418f235155a4d389b2abc3a6245fb01cb0eb1e01

  - name: robin-map
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://github.com/Tessil/robin-map/archive/refs/tags/v0.6.3.tar.gz
        sha256: e6654c8c2598f63eb0b1d52ff8bdf39cfcc91d81dd5d05274a6dca91241cd72f

  - name: pybind11
    buildsystem: simple
    build-commands:
      - python3 setup.py build
      - cmake -DPYBIND11_INSTALL=ON -DPYBIND11_TEST=OFF -DCMAKE_INSTALL_INCLUDEDIR:PATH=${FLATPAK_DEST}/include -DCMAKE_INSTALL_LIBDIR:PATH=${FLATPAK_DEST}/lib -DCMAKE_INSTALL_DATAROOTDIR:PATH=${FLATPAK_DEST}/share .
      - python3 setup.py install --prefix=${FLATPAK_DEST}
      - cmake --build .
      - cmake --install .
    sources:
      - type: archive
        url: https://github.com/pybind/pybind11/archive/v2.6.2.tar.gz
        sha256: 8ff2fff22df038f5cd02cea8af56622bc67f5b64534f1b83b9f133b8366acff2

  - name: OpenImageIO
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DUSE_OPENCV:BOOL=FALSE
      - -DUSE_OPENSSL:BOOL=FALSE
      - -DUSE_QT5:BOOL=FALSE
      - -DUSE_OPENGL:BOOL=TRUE
      - -DUSE_HEIF:BOOL=TRUE
      - -DUSE_OPENJPEG:BOOL=TRUE
      - -DUSE_PYTHON:BOOL=TRUEs
      - -DUSE_FIELD3D:BOOL=FALSE
      - -DOIIO_BUILD_TESTS=0
      - -DOIIO_BUILD_TOOLS=1
      - -DSTOP_ON_WARNING:BOOL=FALSE
      - -DUSE_GIF:BOOL=TRUE
      - -DUSE_FREETYPE:BOOL=TRUE
      - -DUSE_FFMPEG:BOOL=TRUE
      - -DLINKSTATIC=0
      - -DOpenJpeg_ROOT=/app/
      - -DUSE_LIBRAW:BOOL=TRUE
      - -DCMAKE_LIBRARY_PATH=/app/lib
    sources:
      - type: git
        url: git://github.com/OpenImageIO/oiio.git
        tag: v2.2.16.0

  - name: QtOIIO
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_TESTING:BOOL=OFF
      - -DCMAKE_BUILD_TYPE=Release
      - -DILMBASE_INCLUDE_PATH:PATH=/app/include
      - -DOPENEXR_ILMIMF_LIBRARY:PATH=/app/lib
      - -DOPENEXR_HALF_LIBRARY:PATH=/app/lib
    sources:
      - type: git
        url: https://github.com/alicevision/QtOIIO/
        tag: master

  - name: Alembic
    buildsystem: cmake-ninja
    config-opts:
      - -DUSE_TESTS:BOOL=OFF
      - -DUSE_BINARIES:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/alembic/alembic/archive/refs/tags/1.8.2.tar.gz
        sha256: 3f1c466ee1600578689b32b1f2587066d3259704ec7ed1fcf80c324d01274f48

  - name: qmlAlembic
    buildsystem: cmake-ninja
    config-opts:
      - -DALEMBIC_ILMBASE_ROOT:PATH=/app
      - -DILMBASE_ROOT:PATH=/app
      - -DILMBASE_INCLUDE_DIR:PATH=/app/include
      - -DALEMBIC_ILMBASE_IMATH_LIB:PATH=/app/lib
    sources:
      - type: archive
        url: https://github.com/alicevision/qmlAlembic/archive/refs/tags/v2021.1.0.tar.gz
        sha256: e9b535630cfc561f73273f5d25605d94ed30dd4063216b1ca6a8e2692d4c9e00
      - type: patch
        path: remove-find-package.patch

  - name: OpenGV
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      env:
        LIBRARY_PATH: "/app/lib:/usr/lib"
        LD_LIBRARY_PATH: "/app/lib:/usr/lib"
    config-opts:
      - -DBUILD_SHARED_LIBS:BOOL=ON
      - -DBUILD_PYTHON:BOOL=OFF
      - -DBUILD_TESTS:BOOL=OFF
      - -DCMAKE_INSTALL_PREFIX:PATH=/app
    sources:
      - type: git
        url: git://github.com/laurentkneip/opengv.git
        tag: master

  - shared-modules/glu/glu-9.json

  - name: Geogram
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      env:
        LIBRARY_PATH: "/app/lib:/usr/lib"
        LD_LIBRARY_PATH: "/app/lib:/usr/lib"
    config-opts:
      - -DGEOGRAM_LIB_ONLY:BOOL=OFF
      - -DVORPALINE_PLATFORM:STRING=Linux64-gcc-dynamic
      - -DGEOGRAM_USE_SYSTEM_GLFW3:BOOL=ON
      - -DCMAKE_EXE_LINKER_FLAGS="-pie"
      - -DCMAKE_BUILD_TYPE:STRING=Release
    sources:
      - type: archive
        url: https://gforge.inria.fr/frs/download.php/file/38361/geogram_1.7.6.tar.gz
        sha256: 4456d65baa014e9eb0352675f76eca260ed97eb386d23bc5c13af419dc2e8142

  - name: PopSift
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
    sources:
      - type: archive
        url: https://github.com/alicevision/popsift/archive/refs/tags/v0.9.tar.gz
        sha256: a2a0edf9acb3bd9c0164aafc4360c4996bc0d40dbc903772b4a8bc7bbd994510

#UncertaintyTE

  - name: AliceVision
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DAV_BUILD_CUDA:BOOL=OFF
      - -DILMBASE_INCLUDE_PATH:PATH=/app/include
      - -DOPENEXR_ILMIMF_LIBRARY:PATH=/app/lib
      - -DOPENEXR_HALF_LIBRARY:PATH=/app/lib
    sources:
      - type: git
        url: git://github.com/alicevision/AliceVision.git
        tag: v2.4.0

  - name: QtAliceVision
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://github.com/alicevision/QtAliceVision/archive/refs/tags/v2019.2.0.tar.gz
        sha256: aa04671288d5119d94611fb810c7e2f454dd7722f0adf794e5bd0c5820b74845

  - name: Meshroom
    buildsystem: simple
    build-commands:
      - mkdir -p build
      - cd build && cmake -DCMAKE_BUILD_TYPE:STRING=Release -DCMAKE_INSTALL_PREFIX:PATH=/app ..
      - touch build/qtOIIO-prefix/src/qtOIIO-stamp/qtOIIO-download
      - make -C build
    sources:
      - type: git
        url: git://github.com/alicevision/meshroom.git
        commit: ad9f1e874af5a6da47d5bb947b018b509925ddf5
        tag: v2021.1.0


